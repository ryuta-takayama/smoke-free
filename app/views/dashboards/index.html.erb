<% content_for :page_title, "ダッシュボード|smoke free" %>

<div class="db-wrapper" data-controller="dashboard">
  <!-- Topbar header -->
  <header class="db-topbar">
    <div class="brand-left">
      <div class="brand-logo"><%= image_tag 'heart-svgrepo-com.svg', alt: '', class: 'brand-icon' %></div>
       <%= link_to "smoke free", root_path, class: "brand-name" %>
    </div>
    <div class="actions-right">
      <a href="#" class="action-link-1"> アカウント設定</a>
      <%= link_to "ログアウト", destroy_user_session_path, data: {turbo_method: :delete} , class: "action-link-2" %>
    </div>
  </header>
  <!-- Greeting / streak -->
  <section class="db-hero">
    <div class="db-hero-main">
      <h1 class="db-hero-title">おかえりなさい　<%= @user.nickname %>さん!</h1>
      <p class="db-hero-sub">禁煙 <span class="text-success"><%= (@calc.current_streak_days || 0) %>日目</span> です</p>
    </div>
    <div class="db-hero-badge">
      <% badge = latest_streak_badge(@calc.current_streak_days) %>
      <% if badge %>
        <%= image_tag badge[:icon], alt: '', class: 'badge-emoji' %>
        <span class="badge-text"><%= badge[:text] %></span>
      <% end %>
    </div>
  </section>

  <!-- Tabs -->
  <div class="db-tabs">
    <button class="db-tab is-active" data-action="dashboard#showCurrent" data-dashboard-target="tab" data-tab="current">
      <span class="tab-icon">▶︎</span> 現在の挑戦
    </button>
    <button class="db-tab" data-action="dashboard#showHistory" data-dashboard-target="tab" data-tab="history">
      <span class="tab-icon">⏱</span> これまでの成果
    </button>
  </div>

  <!-- Panel: current challenge -->
  <section class="db-panel" data-dashboard-target="panel" data-panel="current">
    <div class="db-metrics">
      <div class="metric-card green">
        <%= image_tag "calender-svgrepo-com.svg", alt: '', class: 'metric-icon' %>
        <div class="metric-main">
          <div class="metric-value"><%= (@calc.current_streak_days || 0) %>日</div>
          <div class="metric-label">現在の継続期間（日数）</div>
        </div>
      </div>
      <div class="metric-card blue">
         <%= image_tag "yen-svgrepo-com.svg", alt: '', class: 'metric-icon' %>
        <div class="metric-main">
          <div class="metric-value">¥<%= (@calc.saved_money_jpy || 0) %></div>
          <div class="metric-label">現在の節約額</div>
        </div>
      </div>
      <div class="metric-card purple">
        <%= image_tag "no-smoking-svgrepo-com.svg", alt: '', class: 'metric-icon' %>
        <div class="metric-main">
          <div class="metric-value"><%= (@calc.avoided_cigarettes || 0) %></div>
          <div class="metric-label">現在の禁煙本数</div>
        </div>
      </div>
      <div class="metric-card orange">
        <%= image_tag "time-twenty-four-svgrepo-com.svg", alt: '', class: 'metric-icon' %>
        <div class="metric-main">
          <div class="metric-value">
            <span data-dashboard-target="timer" data-start-at="<%= @session_start&.iso8601 %>">00:00:00</span>
          </div>
          <div class="metric-label">禁煙時間（時間）</div>
        </div>
      </div>
    </div>

    <!-- Today's action plan -->
    <section class="db-section">
      <header class="db-section-head">
        <div class="head-left">
           <%= image_tag "action-solid-svgrepo-com.svg", alt: '', class: 'head-icon' %>
          <h2 class="head-title">今日のアクションプラン</h2>
        </div>
        <div class="head-right">
          <%= link_to "＋ 追加", new_post_path, class: "btn-ghost" %>
        </div>
      </header>

      <div class="plan-row">
        <% @posts.each do |post| %>
          <% title = post.body.to_s.lines.first.to_s.strip.presence || '（無題）' %>
          <div class="plan-chip">
            <div class="plan-title"><%= title %></div>
          </div>
        <% end %>
      </div>
    </section>

    <!-- Goal and health progress -->
    <div class="db-grid-2">
      <section class="db-card">
        <header class="db-card-head">
          <h3 class="db-card-title">目標達成状況</h3>
        </header>
        <div class="goal-row">
          <div class="goal-labels">
            <div class="goal-item">
              <span class="label">目標</span>
              <span class="value"><%= @goal_item || 'MacBook' %></span>
            </div>
            <div class="goal-item">
              <span class="label">進捗</span>
              <span class="value">100.0%</span>
            </div>
          </div>
          <div class="goal-bar"><span class="bar-fill" style="width:100%"></span></div>
          <div class="goal-stats">
            <div class="stat">¥<%= number_with_delimiter(@goal_saved_jpy || 0) %><span> 貯まった金額</span></div>
            <div class="stat"><%= (@days_left || 0) %>日<span> 達成まで！</span></div>
          </div>
        </div>
      </section>

      <section class="db-card">
        <header class="db-card-head">
          <h3 class="db-card-title">健康改善の進捗</h3>
        </header>
        <% elapsed_minutes = if @session_start.present?
             minutes = ((Time.current - @session_start) / 60).to_i
             minutes.positive? ? minutes : 0
           else
             0
           end %>
        <ul class="health-list">
          <% reached_health_messages(elapsed_minutes).each do |msg| %>
            <li class="ok"><%= msg %></li>
          <% end %>
        </ul>
      </section>
    </div>
  </section>

  <!-- Panel: history/results -->
  <section class="db-panel is-hidden" data-dashboard-target="panel" data-panel="history">
    <div class="db-metrics">
      <div class="metric-card purple">
        <div class="metric-icon">🏆</div>
        <div class="metric-main">
          <div class="metric-value"><%= (@total_challenges || 0) %></div>
          <div class="metric-label">総挑戦回数</div>
        </div>
      </div>
      <div class="metric-card green">
        <div class="metric-icon">📅</div>
        <div class="metric-main">
          <div class="metric-value"><%= (@total_days || 0) %></div>
          <div class="metric-label">累計日数</div>
        </div>
      </div>
      <div class="metric-card blue">
        <div class="metric-icon">💲</div>
        <div class="metric-main">
          <div class="metric-value">¥<%= number_with_delimiter(@total_saved_jpy || 0) %></div>
          <div class="metric-label">累計節約</div>
        </div>
      </div>
      <div class="metric-card red">
        <div class="metric-icon">🎗</div>
        <div class="metric-main">
          <div class="metric-value"><%= (@best_streak_days || 0) %></div>
          <div class="metric-label">最長記録（日）</div>
        </div>
      </div>
    </div>

    <div class="db-grid-2">
      <section class="db-card">
        <header class="db-card-head">
          <h3 class="db-card-title">成果サマリー</h3>
        </header>
        <ul class="summary-list">
          <li>
            <span>累計節約本数</span>
            <strong><%= number_with_delimiter(@total_avoided_cigs || 0) %>本</strong>
          </li>
          <li>
            <span>平均継続期間</span>
            <strong><%= (@avg_streak_days || 0) %>日</strong>
          </li>
          <li>
            <span>現在の継続期間</span>
            <strong class="text-success"><%= (@streak_days || 0) %>日</strong>
          </li>
          <li>
            <span>継続中のセッション</span>
            <strong class="text-warn"><%= (@active_sessions || 0) %>個</strong>
          </li>
        </ul>
      </section>

      <section class="db-card">
        <header class="db-card-head">
          <h3 class="db-card-title">過去の挑戦履歴</h3>
        </header>
        <div class="history-list">
          <div class="history-item">
            <div class="history-main">
              <div class="title">挑戦 #3</div>
              <div class="sub">2023/9/10 〜 2023/11/20　節約: ¥41,180</div>
            </div>
            <a href="#" class="pill-link">71日継続</a>
          </div>
          <div class="history-item">
            <div class="history-main">
              <div class="title">挑戦 #2</div>
              <div class="sub">2023/6/1 〜 2023/7/15　節約: ¥25,520</div>
            </div>
            <a href="#" class="pill-link">44日継続</a>
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- Footer quick links -->
  <footer class="db-footer-links">
    <a href="#" class="footer-card">
      <span class="f-icon">📊</span>
      <div class="f-main">
        <div class="f-title">タイムライン</div>
        <div class="f-sub">詳細な記録を見る</div>
      </div>
    </a>
    <a href="#" class="footer-card">
      <span class="f-icon">🎯</span>
      <div class="f-main">
        <div class="f-title">目標設定</div>
        <div class="f-sub">モチベーション管理</div>
      </div>
    </a>
    <a href="#" class="footer-card">
      <span class="f-icon">⚙</span>
      <div class="f-main">
        <div class="f-title">設定</div>
        <div class="f-sub">アカウント管理</div>
      </div>
    </a>
  </footer>
</div>
