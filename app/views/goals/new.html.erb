<% content_for :page_title, "目標設定" %>

<div class="goal-wrapper">
  <div class="goal-inner">
    <% back_path = request.referer.presence || dashboards_path %>
    <%= render "shared/ap_topbar", icon_to: back_path, back_to: back_path, right: "目標設定" %>

    <%= form_with model: @goal,
                  url: goals_path,
                  local: true,
                  class: "goal-form",
                  data: {
                    controller: "goal-sim",
                    "goal-sim-daily-saving-value": @daily_saving_amount || 0,
                    "goal-sim-saved-money-value": @saved_money_jpy || 0
                  } do |f| %>
      <div class="goal-grid">
        <div class="goal-card goal-card-form">
          <h2 class="goal-card-title">目標設定</h2>
          <div class="goal-fields">
            <div class="goal-field">
              <%= f.label :target_item, "目標商品・やりたいこと", class: "goal-label" %>
              <%= f.text_field :target_item, placeholder: "例）新しいスニーカーを買う", class: "goal-input" %>
            </div>
            <div class="goal-field">
              <%= f.label :target_amount_jpy, "目標金額", class: "goal-label" %>
              <div class="goal-input-prefix">
                <span>¥</span>
                <%= f.number_field :target_amount_jpy,
                                   min: 0,
                                   step: 100,
                                   placeholder: "0",
                                   class: "goal-input",
                                   data: { "goal-sim-target": "amount", action: "input->goal-sim#update change->goal-sim#update" } %>
                <span class="goal-input-suffix">円</span>
              </div>
            </div>
            <div class="goal-field">
              <%= f.label :started_on, "目標開始日", class: "goal-label" %>
              <%= f.date_field :started_on,
                               class: "goal-input",
                               data: { "goal-sim-target": "startDate", action: "input->goal-sim#update change->goal-sim#update" } %>
            </div>
          </div>
        </div>

        <div class="goal-side">
          <div class="goal-card">
            <h2 class="goal-card-title">現在の節約状況</h2>
            <dl class="goal-stats">
              <div class="goal-stat-row">
                <dt>一日の節約額</dt>
                <dd class="goal-stat-value">
                  <%= defined?(@daily_saving_amount) && @daily_saving_amount.present? ? "#{number_to_currency(@daily_saving_amount, unit: '¥', precision: 0)} /日" : "¥○○ /日" %>
                </dd>
              </div>
              <div class="goal-stat-row">
                <dt>吸わなかった本数</dt>
                <dd class="goal-stat-value">
                  <%= defined?(@skipped_cigarettes_per_day) && @skipped_cigarettes_per_day.present? ? "#{@skipped_cigarettes_per_day} 本/日" : "○○ 本/日" %>
                </dd>
              </div>
            </dl>
          </div>

          <div class="goal-card">
            <h2 class="goal-card-title">目標達成シミュレーション</h2>
            <dl class="goal-stats">
              <div class="goal-stat-row">
                <dt>目標達成までの日数</dt>
                <dd class="goal-stat-value" data-goal-sim-target="days">
                  <%= defined?(@days_to_goal) && @days_to_goal.present? ? "#{@days_to_goal} 日" : "— 日" %>
                </dd>
              </div>
              <div class="goal-stat-row">
                <dt>進捗率</dt>
                <dd class="goal-stat-value" data-goal-sim-target="progress">
                  <%= defined?(@goal_progress_rate) && @goal_progress_rate.present? ? "#{@goal_progress_rate}%" : "— %" %>
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </div>

      <div class="goal-submit-area">
        <%= f.submit "設定する", class: "goal-submit" %>
      </div>
    <% end %>
  </div>
</div>
